const express = require("express"); const multer = require("multer"); const fs = require("fs"); const path = require("path"); const app = express(); const PORT = process.env.PORT || 3000; app.use(express.static(__dirname)); app.use(express.json()); const kodFile = path.join(__dirname, "kod.json"); const rekodFile = path.join(__dirname, "rekod.json"); app.post("/getcode", (req, res) => { const { nama, telefon, jabatan } = req.body; let kodList = JSON.parse(fs.readFileSync(kodFile)); let rekodList = fs.existsSync(rekodFile) ? JSON.parse(fs.readFileSync(rekodFile)) : []; if (kodList.length === 0) { return res.send("Maaf, semua kod telah digunakan."); } const kod = kodList.shift(); rekodList.push({ nama, telefon, jabatan, kod, masa: new Date().toISOString() }); fs.writeFileSync(kodFile, JSON.stringify(kodList, null, 2)); fs.writeFileSync(rekodFile, JSON.stringify(rekodList, null, 2)); res.send(`Terima kasih, ${nama}!<br>Kod promosi anda ialah: <strong>${kod}</strong><br>Gunakan semasa pembelian di Agrobazaar Online. Sah sehingga 30 Jun 2025.`); }); const upload = multer({ dest: "uploads/" }); app.post("/upload", upload.single("kodfile"), (req, res) => { const lines = fs.readFileSync(req.file.path, "utf8").split("\n").map(line => line.trim()).filter(line => line !== ""); let existing = []; if (fs.existsSync(kodFile)) { existing = JSON.parse(fs.readFileSync(kodFile)); } const combined = existing.concat(lines); fs.writeFileSync(kodFile, JSON.stringify(combined, null, 2)); fs.unlinkSync(req.file.path); res.send("Kod berjaya dimuat naik!"); }); app.get("/rekod", (req, res) => { const rekodList = fs.existsSync(rekodFile) ? JSON.parse(fs.readFileSync(rekodFile)) : []; res.json(rekodList); }); app.listen(PORT, () => { console.log("Server berjalan di http://localhost:" + PORT); });